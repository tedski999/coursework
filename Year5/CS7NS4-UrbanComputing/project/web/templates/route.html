<!DOCTYPE html>
<html>
	<head>
		<title>Unbustle</title>
		<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
		<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
		<style>
			#map { height: 600px; }
		</style>
	</head>

	<body>
		<h1>Unbustle</h1>
		<a href="javascript:history.back()">Back</a>
		<p>{{route.short}} ({{#if dir}}Inbound{{else}}Outbound{{/if}}): {{route.long}}</p>
		<p>From {{src.name}} to {{dst.name}}</p>
		{{#if trips}}
		{{#each trips as |trip|}}
		<li>
			{{trip.departs}} .. {{trip.stops}} stops .. {{trip.arrives}}
			{{#if trip.vehicle}}{{#if trip.delay includeZero=true}}{{#if trip.delay}}, ~ {{trip.delay}}s{{else}}, On time{{/if}}{{else}}, ~ ??{{/if}}
			- Vehicle #{{lookup trip.vehicle 0}} at ({{lookup trip.vehicle 1}}, {{lookup trip.vehicle 2}}){{/if}}
			"{{trip.sign}}" - <a href="{{../route.id}}/{{trip.id}}?s={{../src.id}}&d={{../dst.id}}&r={{../dir}}">View trip</a></li>
		{{/each}}
		{{else}}
		<p>No trips scheduled</p>
		{{/if}}

		<br/>
		<div id="map"></div>

		<script type="text/javascript">
			var map = L.map("map").setView([0, 0], 1);
			L.tileLayer("https://tile.openstreetmap.org/{z}/{x}/{y}.png", { attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors' }).addTo(map);

			let path;
			{{#each shapes as |shape|}}
			path = L.polyline([{{#each shape as |p|}}[{{lookup p 0}}, {{lookup p 1}}],{{/each}}], {color: "red"}).addTo(map);
			{{/each}}
			map.fitBounds(path.getBounds());

			var src = L.marker([{{src.lat}}, {{src.lon}}]).addTo(map); src.bindPopup("{{src.name}}");
			var dst = L.marker([{{dst.lat}}, {{dst.lon}}]).addTo(map); dst.bindPopup("{{dst.name}}");
		</script>
	</body>
</html>
