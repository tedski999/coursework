<!DOCTYPE html>
<html>
	<head>
		<title>Unbustle</title>
		<script type="text/javascript">
			let interval;

			function toggleLocationSharing() {
				if (document.getElementById("btn").innerHTML != "Enable Location Sharing") {
					disableLocationSharing();
				} else {
					enableLocationSharing();
				}
			}

			function enableLocationSharing() {
				if (navigator.geolocation) {
					document.getElementById("btn").innerHTML = "Disable Location Sharing";
					getPosition(); interval = setInterval(getPosition, 1000);
				} else {
					alert("Geolocation is not supported by this browser");
				}
			}

			function disableLocationSharing() {
				document.getElementById("btn").innerHTML = "Enable Location Sharing";
				clearInterval(interval);
			}

			function getPosition() {
				navigator.geolocation.getCurrentPosition(sendData, showError, { enableHighAccuracy: true, timeout: 60000, maximumAge: 0 });
			}

			function sendData(position) {
				headers = { "Content-Type": "application/json" }
				body = JSON.stringify({
					username: document.getElementById("user").value,
					latitude: position.coords.latitude,
					longitude: position.coords.longitude,
					service_id: document.getElementById("service").value,
					vehicle_id: document.getElementById("vehicle").value,
				})
				fetch("/post", { method: "POST", body: body, headers: headers })
			}

			function showError(error) {
				disableLocationSharing();
				alert(JSON.stringify(error, null, 2));
			}
		</script>
	</head>

	<body>
		<h1>Unbustle</h1>

		<p>Post your own GPS location:</p>
		<input type="text" id="user" value="Anonymous">
		<input type="text" id="service" value="123">
		<input type="text" id="vehicle" value="27-2b">
		<button id="btn" onclick="toggleLocationSharing()">Enable Location Sharing</button>

		<p>User posts:</p>
		<ul>
			{{#each users as |u|}}
			<p><b>{{u.username}}</b></p>
			{{#each u.posts as |p|}}
			<li>{{p.time}}: {{p.service_id}} #{{p.vehicle_id}} is at ({{p.latitude}},{{p.longitude}})</li>
			{{/each}}
			{{/each}}
		</ul>

		<p>Latest AVL data:</p>
		<ul>
			{{#each services as |s|}}
			<p><b>{{s.service_id}}</b></p>
			{{#each s.vehicles as |v|}}
			<li>#{{v.vehicle_id}}: ({{v.latitude}},{{v.longitude}}) going to {{v.headsign}} @{{v.timestamp}}</li>
			{{/each}}
			{{/each}}
		</ul>
	</body>
</html>
